window.jQuery&&window.bemhtml&&(BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.win=window,this._popupInited=!1,this.hasMod("has-unread")&&this.setMod("animation-active","yes"),this._fetchCounter()}},"has-unread":{yes:function(){this.setMod("animation-active","yes")}},"animation-active":{yes:function(){this._subscribeOnAnimationEnd()}}},_subscribeOnAnimationEnd:function(){var e=this.elem("clapper");e.on("animationend",function t(){this.delMod("animation-active"),e.off("animationend",t)}.bind(this))},_initPopup:function(){if(this._popupInited)return!1;this._popup=this.getPopup(),this._popup.on("beforeOpen beforeClose",function(){var e=this._popup.hasMod("visible","yes");this.toggleMod("opened","yes",!e),void 0!==this._rpcBridge&&void 0!==this._rpcBridge.contrAgent.win&&this._rpcBridge.invokeMethod("updatePopupState",!e),e?this._firstOpen=!1:(this.delMod("has-unread"),this._firstOpen=void 0===this._firstOpen||void 0),this._hasLoaded||this.getSpin().setMod("progress","yes")}.bind(this)),this._popupInited=!0},_fetchCounter:function(){$.ajax({url:this._getCounterUrlNewBack(),dataType:"json",type:"GET",xhrFields:{credentials:"include",withCredentials:!0}}).promise().then(function(e){this.onFetchCounterSuccess(e&&e.unviewed_count&&e.services?{counter:e.unviewed_count,services:Object.keys(e.services)}:{counter:0,services:[]})}.bind(this))},onFetchCounterSuccess:function(e){e.counter&&this.onUpdateCounter(e.counter,e.services)},_getCounterUrlNewBack:function(){var e=this._getTld(),t="yandex";return this.params.apiHost&&-1!==this.params.apiHost.indexOf("yandex-team")&&(t="bell.yandex-team"),"https://"+t+e+"/bell/api/v1/get-ticker"},_getIframeUrl:function(e){var t=this.params.iframeUrl||this.params.baseUrl+"/yandex-notifications/"+this.params.iframeVersion+"/iframe/index."+e+".html";return this.hasMod("no-login")&&-1===t.indexOf("no_login")&&(t=t+(-1!==t.indexOf("?")?"&":"?")+"no_login=1"),t},_getLoaderUrl:function(){return this.params.loaderUrl||this.params.baseUrl+"/iframe-loader/"+this.params.loaderVersion+"/index.min.js"},_insertLoaderScript:function(e){var t=document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0],i=document.createElement("script");i.setAttribute("src",this._getLoaderUrl()),t.insertBefore(i,t.lastChild),i.onload=e},_loadIframe:function(){var e={iframeUrl:this._getIframeUrl(this.params.lang),container:this.findElem(this._popup.domElem,"content").get(0)};this._atom=new window.LegoIframeLoader(e),this._rpcBridge=this._atom.getRPCBridge(this),this._atom.on("init",function(e,t){this._onIframeLoad(t)}.bind(this)),this._atom.init()},getPopup:function(){return this._popup||this.findBlockOn("popup","popup2")},getSpin:function(){return this._spin||this.getPopup().findBlockInside("spin2")},init:function(){if(this._rpcBridge)return this;window.LegoIframeLoader?this._loadIframe():this._insertLoaderScript(this._loadIframe.bind(this))},onIconClick:function(e){this._silentLoad=!1,!this._popupInited&&this._initPopup(),this._rpcBridge||this.init(),this._popup.toggleMod("visible","yes")},onDataLoad:function(e){this.setMod(this._popup.domElem,"loaded","yes"),this.getSpin().delMod("progress"),this._hasLoaded=!0,this._popup.hasMod("visible","yes")&&!this._silentLoad&&this._rpcBridge.invokeMethod("resetUnviewed",{})},onUpdateCounter:function(e,t){if(t=t||[],e=!e||e<0?0:e,this._counter=e,this.toggleMod("has-unread","yes",!this._firstOpen&&Boolean(e)),e&&void 0===this._firstOpen){var i="-counter="+e;t.length&&(i+=",-services="+t.join(".")),this.count("3027.1228.487",i,null,{reqid:BEM.blocks["i-global"]&&BEM.blocks["i-global"].param("reqid")||""})}this._firstOpen&&(this._firstOpen=!1),this.elem("ticker").text(Math.min(99,e))},updateCounterWithParams:function(e,t){void 0!==this._rpcBridge&&void 0!==this._rpcBridge.contrAgent.win&&this._rpcBridge.invokeMethod("updateCounterWithParams",{counterParams:e,referrer:t})},_onIframeLoad:function(e){this._rpcBridge.contrAgent.win=e.iframeWin,this._rpcBridge.invokeMethod("onIframeLoad",this.getIframeParams())},getIframeParams:function(e){return{source:this.params.source,serviceDatabaseId:this.params.serviceDatabaseId,services:this.params.services,domain:this.params.domain||this.params.tld,counterParams:this.params.counterParams,referrer:this.params.referrer,apiHost:this.params.apiHost,silent:this._silentLoad}},onInit:function(e){},getDefaultParams:function(){return{baseUrl:"https://gcn.yandex-team.ru",loaderVersion:"stable",iframeVersion:"stable",lang:"ru",referrer:location.href}},count:function(e,t,i,n){t=t||"",i=i||"";n=n||{};var s=["reqid","yuid","serpid","service","ui"].reduce(function(e,t){return e+(n[t]?"/"+t+"="+n[t]:"")},""),r="//yandex"+this._getTld()+"/clck/click/pid=900/cid="+i+"/dtype=stred"+(e?"/path="+e:"")+(t?"/vars="+t:"")+s+"/cts="+(new Date).getTime()+"/*"+document.location.href;document.createElement("IMG").src=r},_getTld:function(){var e=document.location.host.match(/^.*(\..+)$/);return e?e[1]:".ru"},destruct:$.noop},{live:function(){this.liveBindTo("click",function(e){this.onIconClick(e)})}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments)}}},_initPopup:function(){this.__base.apply(this,arguments),this._popup.attachToScope(),this._popup.setAnchor(this.elem("box"))}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this.hasMod("header")&&this.insertIntoHeader()}}},insertIntoHeader:function(){this._getHeader().replacePlaceholder("notifier",this)},_getHeader:function(){return BEM.blocks["serp-header"]}}),BEM.DOM.decl("notifier",{_getHeader:function(){return BEM.blocks.header}}),BEM.DOM.decl("notifier",{_getHeader:function(){return BEM.blocks["serp-header"]}}),BEM.DOM.decl("notifier",{_initPopup:function(){this.__base.apply(this,arguments),BEM.DOM.blocks["cbir-panel"].on({modName:"visibility",modVal:"visible"},function(){this._popup.delMod("visible")},this)}}),BEM.DOM.decl("notifier",{onSetMod:{opened:{yes:function(){this.__base.apply(this,arguments),!1===this._firstOpen&&this.updateCounterWithParams(this._updateCounterParams(),location.href)}}},_updateCounterParams:function(){return this.params.counterParams.reqid=BEM.blocks["i-global"].param("reqid"),this.params.counterParams.serpid=BEM.blocks["i-global"].param("serpid"),this.params.counterParams}}),BEM.DOM.decl("notifier",{onSetMod:{js:{inited:function(){this.__base.apply(this,arguments),this._updateCounterParams()}}},_updateCounterParams:function(){return this.__base.apply(this,arguments),BEM.blocks["i-global"].extendCounterParams(this.params.counterParams),this.params.counterParams}}));